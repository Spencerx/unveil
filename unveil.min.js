(function(){var b={};b.EPSILON=1.0E-4;b.MAX_FLOAT=3.4028235E38;b.MIN_FLOAT=-3.4028235E38;b.MAX_INT=2147483647;b.MIN_INT=-2147483648;b.inherit=function(a){function c(){}c.prototype=a.prototype||a;return new c};b.each=function(a,c,d){if(a.forEach)a.forEach(c,d);else for(var e in a)hasOwnProperty.call(a,e)&&c.call(d,a[e],e,a);return a};b.rest=function(a,c,d){return Array.prototype.slice.call(a,c===undefined||d?1:c)};b.include=function(a,c){return a.indexOf(c)!=-1};b.select=b.filter=function(a,c,d){if(a.filter===
Array.prototype.filter)return a.filter(c,d);var e=[];b.each(a,function(f,i,g){c.call(d,f,i,g)&&e.push(f)});return e};b.extend=function(a){b.rest(arguments).forEach(function(c){for(var d in c)a[d]=c[d]});return a};b.SortedHash=function(a){var c=this;this.data={};this.keyOrder=[];this.length=0;if(a instanceof Array)b.each(a,function(d,e){c.set(e,d)});else a instanceof Object&&b.each(a,function(d,e){c.set(e,d)})};b.SortedHash.prototype.clone=function(){var a=new b.SortedHash;a.length=this.length;b.each(this.data,
function(c,d){a.data[d]=c});a.keyOrder=this.keyOrder.slice(0,this.keyOrder.length);return a};b.SortedHash.prototype.set=function(a,c){if(a===undefined)return this;if(!this.data[a]){this.keyOrder.push(a);this.length+=1}this.data[a]=c;return this};b.SortedHash.prototype.get=function(a){return this.data[a]};b.SortedHash.prototype.del=function(a){if(this.data[a]){this.keyOrder.splice($.inArray(a,this.keyOrder),1);delete this.data[a];this.length-=1}return this};b.SortedHash.prototype.at=function(a){return this.data[this.keyOrder[a]]};
b.SortedHash.prototype.first=function(){return this.at(0)};b.SortedHash.prototype.last=function(){return this.at(this.length-1)};b.SortedHash.prototype.key=function(a){return this.keyOrder[a]};b.SortedHash.prototype.each=function(a){var c=this;b.each(this.keyOrder,function(d,e){a.call(c,e,c.data[d])});return this};b.SortedHash.prototype.eachKey=function(a){var c=this;b.each(this.keyOrder,function(d){a.call(c,d,c.data[d])});return this};b.SortedHash.prototype.values=function(){var a=[];this.eachKey(function(c,
d){a.push(d)});return a};b.SortedHash.prototype.toArray=function(){var a=[];this.eachKey(function(c,d){a.push({key:c,value:d})});return a};b.SortedHash.prototype.map=function(a){var c=this.clone(),d=this;c.each(function(e,f){c.data[d.key(e)]=a.call(c,f)});return c};b.SortedHash.prototype.select=function(a){var c=new b.SortedHash,d=this;this.eachKey(function(e,f){a.call(d,e,f)&&c.set(e,f)});return c};b.SortedHash.prototype.sort=function(a){var c=this.clone();sortedKeys=c.toArray().sort(a);c.keyOrder=
$.map(sortedKeys,function(d){return d.key});return c};b.SortedHash.prototype.intersect=function(a){var c=new b.SortedHash;this.eachKey(function(d,e){a.eachKey(function(f){d===f&&c.set(d,e)})});return c};b.SortedHash.prototype.union=function(a){var c=new b.SortedHash;this.eachKey(function(d,e){c.get(d)||c.set(d,e)});a.eachKey(function(d,e){c.get(d)||c.set(d,e)});return c};b.Aggregators={};b.Aggregators.SUM=function(a){var c=0;a.each(function(d,e){c+=e});return c};b.Aggregators.MIN=function(a){var c=
Infinity;a.each(function(d,e){if(e<c)c=e});return c};b.Aggregators.MAX=function(a){var c=-Infinity;a.each(function(d,e){if(e>c)c=e});return c};b.Aggregators.AVG=function(a){return b.Aggregators.SUM(a)/a.length};b.Aggregators.COUNT=function(a){return a.length};b.Comparators={};b.Comparators.ASC=function(a,c){return a.value===c.value?0:a.value<c.value?-1:1};b.Comparators.DESC=function(a,c){return a.value===c.value?0:a.value>c.value?-1:1};b.Node=function(a){this.nodeId=b.Node.generateId();if(a)this.val=
a.value;this._properties={}};b.Node.prototype.identity=function(){return this.nodeId};b.Node.nodeCount=0;b.Node.generateId=function(){return b.Node.nodeCount+=1};b.Node.prototype.replace=function(a,c){this._properties[a]=c};b.Node.prototype.set=function(a,c,d){this._properties[a]||(this._properties[a]=new b.SortedHash);this._properties[a].set(c,d instanceof b.Node?d:new b.Node({value:d}));return this};b.Node.prototype.get=function(a,c){if(c!==undefined&&this._properties[a]!==undefined)return this._properties[a].get(c)};
b.Node.prototype.all=function(a){return this._properties[a]};b.Node.prototype.first=function(a){return(a=this._properties[a])?a.first():null};b.Node.prototype.value=function(a){return this.values(a).first()};b.Node.prototype.values=function(a){if(!this.all(a))return new b.SortedHash;return this.all(a).map(function(c){return c.val})};b.Node.prototype.toString=function(){var a="Node#"+this.nodeId+" {\n",c=this;b.each(this._properties,function(d,e){a+="  "+e+": "+c.values(e).values()+"\n"});a+="}";return a};
b.Value=function(a){b.Node.call(this,{value:a})};b.Value.prototype=b.inherit(b.Node);b.Value.prototype.clone=function(){var a=new b.Value(this.val);a.replace("items",new b.SortedHash);return a};b.Item=function(a,c,d){var e=this;b.Node.call(this);this.key=c;$.each(d,function(f,i){var g=a.get("properties",f),k;$.isArray(i)||(i=[i]);$.each(i,function(h,l){var m;if(g.type==="collection"){m=new b.Collection({properties:g.collection_properties,items:l});k="collection"}else{m=g.registerValue(l);k=l;m.set("items",
e.key,e)}e.set(f,h,m)})});this.collection=a;a.set("items",c,this)};b.Item.prototype=b.inherit(b.Node);b.Item.prototype.type=function(a){return this.collection.get("properties",a).type};b.Item.prototype.identify=function(){return this.value("name")||this.value("source")||this.key};b.Property=function(a,c,d){b.Node.call(this);this.key=c;this.type=d.type;this.name=d.name;this.descr=d.descr;this.unique=d.unique;this.categories=d.categories;this.collection=a;if(d.properties)this.collection_properties=
d.properties};b.Property.prototype=b.inherit(b.Node);b.Property.prototype.clone=function(a){a=new b.Property(a,this.key,{type:this.type,name:this.name});a.replace("values",new b.SortedHash);return a};b.Property.prototype.toString=function(){return this.name};b.Property.prototype.aggregate=function(a){return a(this.values("values"))};b.Property.prototype.registerValue=function(a){var c=this.get("values",a);if(c===undefined){c=new b.Value(a);this.set("values",a,c)}return c};b.Collection=function(a){b.Node.call(this);
var c=this;if(a){$.each(a.properties,function(d,e){var f=new b.Property(c,d,e);c.set("properties",d,f)});this.replace("items",new b.SortedHash);$.each(a.items,function(d,e){new b.Item(c,d,e,true)})}};b.Collection.transformers={};b.Collection.prototype=b.inherit(b.Node);b.Collection.prototype.filter=function(a){var c=new b.Collection;c.replace("items",a.items(this));this.all("properties").eachKey(function(d,e){var f=e.clone(c);e.all("values").eachKey(function(i,g){var k=c.all("items").intersect(g.all("items"));
if(k.length>0){var h=g.clone();h.replace("items",k);f.set("values",i,h)}});c.set("properties",d,f)});return c};b.Collection.prototype.transform=function(a,c){return b.Collection.transformers[a].call(this,this,c)};b.Criterion=function(a,c,d){this.operator=a;this.property=c;this.value=d;this.children=[]};b.Criterion.operators={};b.Criterion.operators.AND=function(a,c){if(c.length===0)return new b.SortedHash;for(var d=c[0].items(a),e=1;e<c.length;e++)d=d.intersect(c[e].items(a));return d};b.Criterion.operators.OR=
function(a,c){for(var d=new b.SortedHash,e=0;e<c.length;e++)d=d.union(c[e].items(a));return d};b.Criterion.operators.CONTAINS=function(a,c,d){return a.get("properties",c).get("values",d).all("items")};b.Criterion.operators.GT=function(a,c,d){a=a.get("properties",c).all("values");var e=new b.SortedHash;a=a.select(function(f,i){return i.val>=d});a.each(function(f,i){e=e.union(i.all("items"))});return e};b.Criterion.prototype.add=function(a){this.children.push(a);return this};b.Criterion.prototype.items=
function(a){return this.operator==="AND"?b.Criterion.operators.AND(a,this.children):this.operator==="OR"?b.Criterion.operators.OR(a,this.children):b.Criterion.operators[this.operator](a,this.property,this.value)};b.Collection.transformers.group=function(a,c){function d(g,k,h){var l=new b.SortedHash;g.eachKey(function(m,o){var j=o.value(k);l.set(j,j)});return Aggregators[h](l)}var e=new b.Collection,f=a.get("properties",c.property),i=f.all("values");a.all("properties").eachKey(function(g,k){if(k.key===
f.key||k.type==="number"){var h=new b.Property(e,g,{type:k.type,name:k.name,unique:k.unique});e.set("properties",g,h)}});i.each(function(g,k){var h={},l=k.all("items");e.all("properties").eachKey(function(m){h[m]=m===c.property?k.val:d(l,m,c.aggregator)});new b.Item(e,k.val,h)});return e};b.Collection.transformers.group.label="Group By";b.Collection.transformers.group.params={property:{name:"Property",type:"property"},aggregator:{name:"Aggregator Function",type:"aggregator"}};b.DataGraph=function(a){b.Node.call(this);
var c=this;b.select(a,function(d,e){if(d.type==="type"){c.set("types",e,new b.Type(this,e,d));return true}return false});b.select(a,function(d,e){if(d.type!=="type"){var f=c.get("resources",e)||new b.Resource(c,e,d);c.set("resources",e,f);if(!c.get("types",d.type))throw"Type '"+d.type+"' not found for "+e+"...";c.get("types",d.type).set("resources",e,f);return true}return false});this.all("resources").each(function(d,e){e.build()})};b.DataGraph.prototype=b.inherit(b.Node);b.DataGraph.prototype.find=
function(a){this.all("resources").select(function(c,d){for(var e in a)if(c==="type"){if(a[e]!==d.type.key)return false}else if(a[e]!==d.get(e))return false;return true})};b.VALUE_TYPES=["string","number","date","datetime","location"];b.isValueType=function(a){return b.include(b.VALUE_TYPES,a)};b.Type=function(a,c,d){var e=this;b.Node.call(this);this.g=a;this.key=c;this.name=d.name;b.each(d.properties,function(f,i){var g=new b.Node;g.key=i;g.unique=f.unique;g.name=f.name;g.expected_type=f.expected_type;
g.replace("values",new b.SortedHash);g.isValueType=function(){return b.isValueType(g.expected_type)};g.isObjectType=function(){return!g.isValueType()};e.set("properties",i,g)})};b.Type.prototype=b.inherit(b.Node);b.Resource=function(a,c,d){b.Node.call(this);this.g=a;this.key=c;this.type=a.get("types",d.type);this.data=d};b.Resource.prototype=b.inherit(b.Node);b.Resource.prototype.build=function(){var a=this;b.each(this.data.properties,function(c,d){var e=Array.isArray(c)?c:[c],f=a.type.get("properties",
d);if(!f)throw"property "+d+" not found at "+a.type.key+" for resource "+a.key+"";a.replace(f.key,new b.SortedHash);f.isObjectType()?b.each(e,function(i){var g=a.g.get("resources",i);if(!g)throw"Can't reference "+i;a.set(f.key,g.key,g)}):b.each(e,function(i){var g=f.get("values",i);g||(g=new b.Node({value:i}));a.set(f.key,i,g);f.set("values",i,g)})})};b.Resource.prototype.get=function(a,c){var d=this.type.get("properties",a);if(!d)return null;return arguments.length===1?d.isObjectType()?d.unique?
this.first(a):this.all(a):d.unique?this.value(a):this.values(a):b.Node.prototype.get.call(this,a,c)};(function(){function a(d,e){return{x:d||0,y:e||0,add:function(f){return a(this.x+f.x,this.y+f.y)}}}function c(d,e,f,i,g,k){d=d!==undefined?d:1;i=i!==undefined?i:1;return{a:d,b:e||0,c:f||0,d:i,tx:g||0,ty:k||0,concat:function(h){return c(this.a*h.a+this.c*h.b,this.b*h.a+this.d*h.b,this.a*h.c+this.c*h.d,this.b*h.c+this.d*h.d,this.a*h.tx+this.c*h.ty+this.tx,this.b*h.tx+this.d*h.ty+this.ty)},deltaTransformPoint:function(h){return a(this.a*
h.x+this.c*h.y,this.b*h.x+this.d*h.y)},inverse:function(){var h=this.a*this.d-this.b*this.c;return c(this.d/h,-this.b/h,-this.c/h,this.a/h,(this.c*this.ty-this.d*this.tx)/h,(this.b*this.tx-this.a*this.ty)/h)},rotate:function(h,l){return this.concat(c.rotation(h,l))},scale:function(h,l,m){return this.concat(c.scale(h,l,m))},transformPoint:function(h){return a(this.a*h.x+this.c*h.y+this.tx,this.b*h.x+this.d*h.y+this.ty)},translate:function(h,l){return this.concat(c.translation(h,l))}}}a.distance=function(d,
e){return Math.sqrt(Math.pow(e.x-d.x,2)+Math.pow(e.y-d.y,2))};a.direction=function(d,e){return Math.atan2(e.y-d.y,e.x-d.x)};c.rotation=function(d,e){var f=c(Math.cos(d),Math.sin(d),-Math.sin(d),Math.cos(d));if(e)f=c.translation(e.x,e.y).concat(f).concat(c.translation(-e.x,-e.y));return f};c.scale=function(d,e,f){e=e||d;d=c(d,0,0,e);if(f)d=c.translation(f.x,f.y).concat(d).concat(c.translation(-f.x,-f.y));return d};c.translation=function(d,e){return c(1,0,0,1,d,e)};c.IDENTITY=c();c.HORIZONTAL_FLIP=
c(-1,0,0,1);c.VERTICAL_FLIP=c(1,0,0,-1);b.Point=a;b.Matrix=c})();b.Actor=function(a){b.Node.call(this);this.childCount=0;this.properties=b.extend({x:0,y:0,scaleX:1,scaleY:1,rotation:0,localX:0,localY:0,localScaleX:1,localScaleY:1,localRotation:0,fillStyle:"#000",strokeStyle:"#000",lineWidth:1,lineCap:"butt",lineJoin:"miter",globalAlpha:1,miterLimit:10,visible:true,transformMode:"object"},a);this.replace("children",new b.SortedHash);this.tweens={};this.active=false;this.handlers={}};b.Actor.registeredActors=
{};b.Actor.prototype=b.inherit(b.Node);b.Actor.prototype.bind=function(a,c){this.handlers[a]||(this.handlers[a]=[]);this.handlers[a].push(c)};b.Actor.prototype.trigger=function(a){if(this.handlers[a])for(var c in this.handlers[a])this.handlers[a][c].apply(this,[])};b.Actor.create=function(a){var c=b.Actor.registeredActors[a.type];if(!c)throw"Actor type unregistered: '"+a.type+"'";return new c(a)};b.Actor.prototype.id=function(){return this.p("id")||this.nodeId};b.Actor.prototype.add=function(a){var c;
c=a instanceof b.Actor?a:b.Actor.create(a);if(!this.scene)throw"You can't add childs to actors that don't have a scene reference";this.scene.registerActor(c);this.set("children",c.id(),c);c.parent=this;c.init&&c.init();a.actors&&a.actors.forEach(function(d){c.add(d)});return c};b.Actor.prototype.get=function(){return arguments.length===1?this.scene.actors[arguments[0]]:b.Node.prototype.get.call(this,arguments[0],arguments[1])};b.Actor.prototype.remove=function(a){var c=this;if(a instanceof Function)this.traverse().forEach(function(d){a(d)&&
c.scene.remove(d.id())});else{if(this.get("children",a)){this.all("children").del(a);delete this.scene.actors[a];delete this.scene.interactiveActors[a]}this.all("children").each(function(d,e){e.remove(a)})}};b.Actor.prototype.traverse=function(){return this.scene.properties.traverser(this)};b.Actor.prototype.property=function(a,c){if(c)return this.properties[a]=c;else return this.properties[a]instanceof Function?this.properties[a].call(this):this.properties[a]};b.Actor.prototype.p=b.Actor.prototype.property;
b.Actor.prototype.animate=function(a,c,d){var e=this.scene,f=(new b.Tween(this.properties)).to(c||1,a).easing(d||b.Tween.Easing.Expo.EaseInOut).onComplete(function(){e.unexecute(b.cmds.RequestFramerate);b.TweenManager.remove(f)});e.execute(b.cmds.RequestFramerate);return f.start()};b.Actor.prototype.tShape=function(){return b.Matrix().translate(this.p("localX"),this.p("localY")).rotate(this.p("localRotation")).scale(this.p("localScaleX"),this.p("localScaleY"))};b.Actor.prototype.tWorldParent=function(){return this.parent?
this.parent._tWorld:b.Matrix()};b.Actor.prototype.tWorld=function(){return b.Matrix().concat(this.tWorldParent()).translate(this.p("x"),this.p("y")).rotate(this.p("rotation")).scale(this.p("scaleX"),this.p("scaleY"))};b.Actor.prototype.compileMatrix=function(){this.update();this._tWorld=this.tWorld();this.all("children")&&this.all("children").each(function(a,c){c.compileMatrix()})};b.Actor.prototype.update=function(){b.TweenManager.update()};b.Actor.prototype.applyStyles=function(a){a.fillStyle=this.p("fillStyle");
a.strokeStyle=this.p("strokeStyle");a.lineWidth=this.p("lineWidth");a.lineCap=this.p("lineCap");a.lineJoin=this.p("lineJoin");a.globalAlpha=this.p("globalAlpha");a.miterLimit=this.p("miterLimit")};b.Actor.prototype.draw=function(){};b.Actor.prototype.checkActive=function(a,c,d){c=new b.Point(c,d);d=this._tWorld.inverse().transformPoint(c);c=d.x;d=d.y;if(this.bounds&&a.isPointInPath){this.drawBounds(a);this.active=a.isPointInPath(c,d)?true:false}return this.active};b.Actor.prototype.drawBounds=function(a){var c=
this.bounds(),d,e;d=c.shift();a.beginPath();for(a.moveTo(d.x,d.y);e=c.shift();)a.lineTo(e.x,e.y);a.lineTo(d.x,d.y)};b.Actor.prototype.render=function(a,c){if(this.p("visible")){this.applyStyles(a);this.transform(a,c);this.draw(a,c)}};b.Actor.prototype.transform=function(a,c){var d=this.tShape().concat(c).concat(this._tWorld);if(this.p("transformMode")==="origin"){d=d.transformPoint(b.Point(0,0));a.setTransform(1,0,0,1,d.x,d.y)}else a.setTransform(d.a,d.b,d.c,d.d,d.tx,d.ty)};b.traverser={};b.traverser.BreadthFirst=
function(a){var c=[],d=[];for(c.push(a);c.length>0;){a=c.shift();if(a.p("visible")){d.push(a);a.all("children").each(function(e,f){c.push(f)})}}return d};b.traverser.DepthFirst=function(a){var c=[],d=[];for(c.push(a);c.length>0;){a=c.pop();if(a.p("visible")){d.push(a);a.all("children").each(function(e,f){c.push(f)})}}return d};b.behaviors={};b.behaviors.adjust=function(a,c){var d=a.bounds();if(a.bounded){c.a=c.d=Math.max(1,c.a);c.tx=Math.max(d.x,Math.min(0,c.tx));c.ty=Math.max(d.y,Math.min(0,c.ty))}return c};
b.behaviors.Zoom=function(a){function c(d){d=d.wheelDelta/120||-d.detail;var e=a.tView.scale(1+0.0050*d,1+0.0050*d,b.Point(a.scene.mouseX,a.scene.mouseY));a.tView=d<0?b.behaviors.adjust(a,e):e;a.trigger("viewChange")}a.canvas.addEventListener("mousewheel",c,false);a.canvas.addEventListener("DOMMouseScroll",c,false)};b.behaviors.Pan=function(a){function c(){e=false}var d,e=false;a.canvas.addEventListener("mousedown",function(){p=b.Point(a.mouseX,a.mouseY);d=a.tView;e=true},false);a.canvas.addEventListener("mousemove",
function(){if(e){var f=b.Matrix.translation(a.mouseX-p.x,a.mouseY-p.y).concat(d);a.tView=b.behaviors.adjust(a,f);a.trigger("viewChange")}},false);a.canvas.addEventListener("mouseup",c,false);a.canvas.addEventListener("mouseout",c,false)};b.Display=function(a,c){function d(){e.scene.trigger("interact")}var e=this;b.Actor.call(this,b.extend({fillStyle:""},c));this.scene=a;this.element=document.getElementById(c.container);this.canvas=document.createElement("canvas");this.canvas.setAttribute("width",
c.width);this.canvas.setAttribute("height",c.height);this.canvas.style.position="relative";this.element.appendChild(this.canvas);this.width=c.width;this.height=c.height;this.bounded=c.bounded||true;this.ctx=this.canvas.getContext("2d");this.tView=b.Matrix();if(c.zooming)this.zoombehavior=new b.behaviors.Zoom(this);if(c.panning)this.panbehavior=new b.behaviors.Pan(this);this.canvas.addEventListener("mousemove",d,false);this.canvas.addEventListener("DOMMouseScroll",d,false);this.canvas.addEventListener("mousemove",
function(f){var i=e.tView.inverse(),g;if(f.offsetX)g=new b.Point(f.offsetX,f.offsetY);else if(f.layerX)g=new b.Point(f.layerX,f.layerY);if(g){e.mouseX=g.x;e.mouseY=g.y;worldPos=i.transformPoint(g);e.scene.mouseX=parseInt(worldPos.x,10);e.scene.mouseY=parseInt(worldPos.y,10);e.scene.activeDisplay=e}},false);this.canvas.addEventListener("mousewheel",d,false);this.canvas.addEventListener("mouseout",function(){e.scene.mouseX=NaN;e.scene.mouseY=NaN},false);this.canvas.addEventListener("click",function(){b.each(e.scene.activeActors,
function(f){f.trigger("click")})},false)};b.Display.prototype=b.inherit(b.Actor);b.Display.prototype.displayPos=function(){return this.tView.transformPoint(pos)};b.Display.prototype.zoom=function(){return this.tView.a};b.Display.prototype.worldPos=function(a){return this.tView.inverse().transformPoint(a)};b.Display.prototype.bounds=function(){var a=Math.max(0,this.scene.p("width")-this.width),c=Math.max(0,this.scene.p("width")-this.width);return{x:(1-this.tView.a)*this.width-this.tView.a*a,y:(1-this.tView.a)*
this.height-this.tView.a*c}};b.Display.prototype.refresh=function(){var a=this,c,d;this.ctx.clearRect(0,0,this.width,this.height);if(this.scene.p("fillStyle")!==""){this.ctx.fillStyle=this.scene.p("fillStyle");this.ctx.fillRect(0,0,this.width,this.height)}this.ctx.save();c=this.scene.traverse();c.shift();b.each(c,function(e){e.render(a.ctx,a.tView)});d=this.traverse();c.shift();b.each(d,function(e){e.render(a.ctx,b.Matrix())});this.ctx.restore()};b.cmds={};b.cmds.RequestFramerate=function(a,c){this.scene=
a;this.requests=0;this.framerate=c.framerate;this.originalFramerate=this.scene.framerate};b.cmds.RequestFramerate.className="RequestFramerate";b.cmds.RequestFramerate.prototype.execute=function(){this.requests+=1;this.scene.setFramerate(this.framerate)};b.cmds.RequestFramerate.prototype.unexecute=function(){this.requests-=1;this.requests<=0&&this.scene.setFramerate(this.originalFramerate)};b.Scene=function(a){var c=this;b.Actor.call(this,b.extend({width:0,height:0,fillStyle:"",idleFramerate:0,framerate:50,
traverser:b.traverser.DepthFirst},a));this.mouseY=this.mouseX=NaN;this.interactiveActors={};this.activeActors=[];this.actors={};this.scene=this;this.displays=[];a.displays&&b.each(a.displays,function(f){c.displays.push(new b.Display(c,f))});this.activeDisplay=this.displays[0];this.fps=0;this.framerate=this.p("idleFramerate");this.commands={};this.register(b.cmds.RequestFramerate,{framerate:this.p("framerate")});a.actors&&b.each(a.actors,function(f){c.add(f)});var d,e=false;this.bind("interact",function(){if(!e){c.execute(b.cmds.RequestFramerate);
e=true}clearTimeout(d);d=setTimeout(function(){e=false;c.unexecute(b.cmds.RequestFramerate)},1E3)})};b.Scene.prototype=b.inherit(b.Actor);b.Scene.prototype.registerActor=function(a){var c=a.id();if(this.actors[c])throw"ID '"+c+"' already registered.";a.scene=this;this.actors[c]=a;if(a.p("interactive"))this.interactiveActors[a.id()]=a};b.Scene.prototype.start=function(){this.running=true;this.trigger("start");this.loop();this.checkActiveActors()};b.Scene.prototype.setFramerate=function(a){this.framerate=
a;clearTimeout(this.nextLoop);clearTimeout(this.nextPick);this.loop();this.checkActiveActors()};b.Scene.prototype.loop=function(){var a=this,c;if(this.running){this.fps=1E3/c<a.framerate?1E3/c:a.framerate;c=(new Date).getTime();this.render();c=(new Date).getTime()-c;if(this.framerate>0)this.nextLoop=setTimeout(function(){a.loop()},1E3/a.framerate-c)}};b.Scene.prototype.render=function(){this.trigger("frame");this.compileMatrix();this.refreshDisplays()};b.Scene.prototype.stop=function(){this.running=
false;this.trigger("stop")};b.Scene.prototype.checkActiveActors=function(){var a=this.displays[0].ctx,c=this,d=this.activeActors;if(this.running){if(this.scene.mouseX!==NaN){this.activeActors=[];b.each(this.interactiveActors,function(e){if(e.checkActive(a,c.scene.mouseX,c.scene.mouseY)){c.activeActors.push(e);b.include(d,e)||e.trigger("mouseover")}else b.include(d,e)&&e.trigger("mouseout")})}if(c.framerate>0)this.nextPick=setTimeout(function(){c.checkActiveActors()},1E3/Math.min(c.framerate,15))}};
b.Scene.prototype.refreshDisplays=function(){b.each(this.displays,function(a){a.compileMatrix();a.refresh()})};b.Scene.prototype.display=function(a){a=new b.Display(this,a);this.displays.push(a);return a};b.Scene.prototype.register=function(a,c){this.commands[a.className]=new a(this,c)};b.Scene.prototype.execute=function(a){this.commands[a.className].execute()};b.Scene.prototype.unexecute=function(a){this.commands[a.className].unexecute()};b.TweenManager=b.TweenManager||function(){var a,c,d=[];this.add=
function(e){d.push(e)};this.remove=function(e){for(var f=0,i=d.length;f<i;f++)if(e==d[f]){d.splice(f,1);return}};this.update=function(){a=0;for(c=(new Date).getTime();a<d.length;)d[a].update(c)?a++:d.splice(a,1)};return this}();b.Tween=function(a){b.TweenManager.add(this);var c={},d={},e={},f=1E3,i=0,g=null,k=b.Tween.Easing.Back.EaseInOut,h=null,l=null,m=null,o=false;this.to=function(j,n){f=j*1E3;for(var q in n)if(a[q]!==null)e[q]=n[q];return this};this.start=function(){o=false;g=(new Date).getTime()+
i;for(var j in e)if(a[j]!==null){c[j]=a[j];d[j]=e[j]-a[j]}return this};this.delay=function(j){i=j*1E3;return this};this.easing=function(j){k=j;return this};this.chain=function(j){h=j};this.onUpdate=function(j){l=j;return this};this.onComplete=function(j){m=j;return this};this.update=function(j){var n;if(j<g||g===null)return true;if(o)return h===null;j=j-g;if(j>f){o=true;g=null;m!==null&&m();if(h!==null){h.start();return true}else return false}for(n in d)a[n]=k(j,c[n],d[n],f);l!==null&&l.apply(a);
return true};this.destroy=function(){b.TweenManager.remove(this)}};b.Tween.Easing={Back:{},Elastic:{},Expo:{},Linear:{}};b.Tween.Easing.Back.EaseIn=function(a,c,d,e){return d*(a/=e)*a*(2.70158*a-1.70158)+c};b.Tween.Easing.Back.EaseOut=function(a,c,d,e){return d*((a=a/e-1)*a*(2.70158*a+1.70158)+1)+c};b.Tween.Easing.Back.EaseInOut=function(a,c,d,e){var f=1.70158;if((a/=e/2)<1)return d/2*a*a*(((f*=1.525)+1)*a-f)+c;return d/2*((a-=2)*a*(((f*=1.525)+1)*a+f)+2)+c};b.Tween.Easing.Elastic.EaseIn=function(a,
c,d,e){if(a==0)return c;if((a/=e)==1)return c+d;var f=e*0.3,i=f/4;return-(d*Math.pow(2,10*(a-=1))*Math.sin((a*e-i)*2*Math.PI/f))+c};b.Tween.Easing.Elastic.EaseOut=function(a,c,d,e){if(a==0)return c;if((a/=e)==1)return c+d;var f=e*0.3,i=f/4;return d*Math.pow(2,-10*a)*Math.sin((a*e-i)*2*Math.PI/f)+d+c};b.Tween.Easing.Elastic.EaseInOut=function(a,c,d,e){if(a==0)return c;if((a/=e/2)==2)return c+d;var f=e*0.3*1.5,i=f/4;if(a<1)return-0.5*d*Math.pow(2,10*(a-=1))*Math.sin((a*e-i)*2*Math.PI/f)+c;return d*
Math.pow(2,-10*(a-=1))*Math.sin((a*e-i)*2*Math.PI/f)*0.5+d+c};b.Tween.Easing.Expo.EaseIn=function(a,c,d,e){return a==0?c:d*Math.pow(2,10*(a/e-1))+c};b.Tween.Easing.Expo.EaseOut=function(a,c,d,e){return a==e?c+d:d*(-Math.pow(2,-10*a/e)+1)+c};b.Tween.Easing.Expo.EaseInOut=function(a,c,d,e){if(a==0)return c;if(a==e)return c+d;if((a/=e/2)<1)return d/2*Math.pow(2,10*(a-1))+c;return d/2*(-Math.pow(2,-10*--a)+2)+c};b.Tween.Easing.Linear.EaseNone=function(a,c,d,e){return d*a/e+c};b.Tween.Easing.Linear.EaseIn=
function(a,c,d,e){return d*a/e+c};b.Tween.Easing.Linear.EaseOut=function(a,c,d,e){return d*a/e+c};b.Tween.Easing.Linear.EaseInOut=function(a,c,d,e){return d*a/e+c};b.Rect=function(a){b.Actor.call(this,b.extend({width:0,height:0,fillStyle:"#777",strokeStyle:"#000",lineWidth:0},a))};b.Actor.registeredActors.rect=b.Rect;b.Rect.prototype=b.inherit(b.Actor);b.Rect.prototype.bounds=function(){return[{x:0,y:0},{x:this.p("width"),y:0},{x:this.p("width"),y:this.p("height")},{x:0,y:this.p("height")}]};b.Rect.prototype.draw=
function(a){this.p("fillStyle")&&a.fillRect(0,0,this.p("width"),this.p("height"));this.p("lineWidth")>0&&a.strokeRect(0,0,this.p("width"),this.p("height"))};b.Label=function(a){b.Actor.call(this,b.extend({text:"",textAlign:"start",font:"12px Helvetica, Arial",fillStyle:"#444",lineWidth:0,backgroundStyle:"#eee",background:false},a))};b.Actor.registeredActors.label=b.Label;b.Label.prototype=b.inherit(b.Actor);b.Label.prototype.draw=function(a){a.font=this.p("font");a.textAlign=this.p("textAlign");a.fillText(this.p("text"),
0,0)};b.Circle=function(a){b.Actor.call(this,b.extend({radius:20,strokeWeight:2,lineWidth:3,strokeStyle:"#fff"},a))};b.Actor.registeredActors.circle=b.Circle;b.Circle.prototype=b.inherit(b.Actor);b.Circle.prototype.bounds=function(){return[{x:-this.p("radius"),y:-this.p("radius")},{x:this.p("radius"),y:-this.p("radius")},{x:this.p("radius"),y:this.p("radius")},{x:-this.p("radius"),y:this.p("radius")}]};b.Circle.prototype.draw=function(a){a.fillStyle=this.p("fillStyle");a.strokeStyle=this.p("strokeStyle");
a.lineWidth=this.p("lineWidth");a.beginPath();a.arc(0,0,this.p("radius"),0,Math.PI*2,false);a.closePath();this.p("lineWidth")>0&&a.stroke();a.fill()};b.Path=function(a){b.Actor.call(this,b.extend({points:[],lineWidth:1,strokeStyle:"#000",fillStyle:""},a));this.transformedPoints=this.points=[].concat(this.p("points"))};b.Actor.registeredActors.path=b.Path;b.Path.prototype=b.inherit(b.Actor);b.Path.prototype.transform=function(a,c){this.transformedPoints=this.points=[].concat(this.p("points"));if(this.p("transformMode")===
"origin"){var d=this.tShape().concat(c).concat(this._tWorld);a.setTransform(1,0,0,1,0,0);this.transformedPoints=this.points.map(function(e){var f=d.transformPoint(e),i=d.transformPoint(b.Point(e.cp1x,e.cp1y)),g=d.transformPoint(b.Point(e.cp2x,e.cp2y));f={x:f.x,y:f.y};if(e.cp1x&&e.cp1y){f.cp1x=i.x;f.cp1y=i.y}if(e.cp2x&&e.cp2y){f.cp2x=g.x;f.cp2y=g.y}return f})}else b.Actor.prototype.transform.call(this,a,c)};b.Path.prototype.draw=function(a){var c=[].concat(this.transformedPoints),d;if(c.length>=1){a.beginPath();
d=c.shift();for(a.moveTo(d.x,d.y);d=c.shift();)if(d.cp1x&&d.cp2x)a.bezierCurveTo(d.cp1x,d.cp1y,d.cp2x,d.cp2y,d.x,d.y);else d.cp1x?a.quadraticCurveTo(d.cp1x,d.cp1y,d.x,d.y):a.lineTo(d.x,d.y);this.p("lineWidth")>0&&this.p("strokeStyle")!==""&&a.stroke();this.p("fillStyle")!==""&&a.fill();a.closePath()}};if(this!=="undefined")this.uv=b;if(typeof exports!=="undefined")exports.uv=b})();
